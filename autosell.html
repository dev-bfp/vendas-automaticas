<!DOCTYPE html>
<html lang="pt-br">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoSell</title>
<style>
    /* Estilos de Tabela */
    h1 {
        color: #000000;        /* Define a cor do texto */
        font-size: 36px;        /* Define o tamanho da fonte */
        font-family: 'Arial', sans-serif;  /* Define a fonte */
        font-weight: bold;      /* Define o peso da fonte (negrito) */
        text-align: center;     /* Alinha o texto ao centro */
        margin-top: 0px;       /* Define a margem superior */
        margin-bottom: 20px;    /* Define a margem inferior */
        }


    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        padding: 20px;
        background-color: #f0ebf8; /* Define o fundo da página como vermelho */
    }

    table {
        width: 100%;
        max-width: 600px;
        border-collapse: collapse; 
        border: none;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        background-color: #ffffff;
        margin-bottom: 7px;
    }
    th, td {
        color: #000000;  
        padding: 15px;
        text-align: right;
        vertical-align: auto;
        border: none;
        border-radius: 10px;
        margin-top: 5px;    
    }
    th {
        width: 25%;
        border: none;
        vertical-align: center;
        border-radius: 10px;
    }
    input, select, textarea {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
        border-radius: 10px;
        border: 1px solid #000000;
        
    }

    /* Estilização do botão Enviar */
    button {
        width: 80%;
        padding: 12px;
        background-color: #07d870; /* Cor de fundo azul */
        color: rgb(0, 0, 0); /* Cor do texto */
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.2s; /* Transições suaves */
        margin-top: 10px;
    }

    /* Efeito de hover (quando o usuário passa o mouse sobre o botão) */
    button:hover {
        background-color: #0f6b04; /* Cor mais escura quando passar o mouse */
        color: rgb(255, 255, 255); /* Cor do texto */
        font-weight: bold;
        transform: scale(1.05); /* Leve aumento de tamanho para indicar interação */
    }

    /* Efeito de foco (quando o botão é focado, por exemplo, ao ser clicado ou selecionado) */
    button:focus {
        outline: none; /* Remove o contorno padrão */
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); /* Sombra azul suave ao focar */
    }

    /* Efeito de clique (quando o botão é pressionado) */
    button:active {
        background-color: #004085; /* Cor ainda mais escura no clique */
        transform: scale(1); /* Retorna ao tamanho original */
    }


    .produtos {
        display: inline-flex;
        gap: 10px; /* Espaçamento entre os checkboxes */
        flex-wrap: wrap;
    }

    .produtos label {
        display: flex;
        align-items: center; /* Alinha o checkbox à esquerda e o texto à direita */
        width: 80%; /* Ajuste para 2 colunas (50% com o espaço entre os itens) */
    }

    .produtos input[type="checkbox"] {
        margin-right: 5px; /* Espaçamento entre o checkbox e o texto */
        width: 10%;
    }

    .produtos input[type="number"] {
        width: 30%;
        margin-left: auto;
        margin-right: 5px;
    }

    #planoInfo {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        padding: 10px;
        background-color: #eeeeee;
        border-radius: 5px;
        text-align: center;
    }
    
    #sexo label {
        display: inline-block;
        margin-right: 0px; /* Espaço entre os checkboxes */
    }

    #tipoCliente label {
        display: inline-block;
        margin-right: 0px; /* Espaço entre os checkboxes */
    }
    
    #contribuinteIcms label {
        display: inline-flex; /* Alinha o checkbox e o texto na mesma linha */
        align-items: center; /* Alinha verticalmente o texto com o checkbox */
        margin-right: 15px; /* Espaçamento entre as opções */
        font-family: Arial, sans-serif;
    }

    #contribuinteIcms input[type="checkbox"] {
        margin-right: 5px; /* Espaçamento entre o checkbox e o texto */
    }

    #temCadastro label {
        display: inline-block;
        margin-right: 0px; /* Espaço entre os checkboxes */
    }

    #moradia label {
        display: inline-block;
        margin-right: 0px; /* Espaço entre os checkboxes */
    }

    #arca {
        display: block;           /* Garante que o botão se comporte como um bloco */
        width: auto;              /* Ajuste automático do tamanho ao conteúdo */
        padding: 8px 16px;        /* Menor preenchimento */
        font-size: 14px;          /* Reduz o tamanho da fonte */
        margin: 0px auto;        /* Centraliza horizontalmente dentro do elemento pai */
    }
    /* Efeito ao passar o mouse sobre o botão */
    #ARCA:hover {
        background-color: #45a049; /* Cor do botão quando hover */
    }

    #restricaoInfo {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        padding: 10px;
        background-color: #eeeeee;
        border-radius: 5px;
        text-align: center;
    }

    #cpf-icon {
        color: green; /* Cor padrão para o ícone de sucesso */
        display: none; /* Inicialmente oculto */
    }

    #cpf-icon.valid {
        display: inline; /* Exibido se válido */
        color: green;
    }

    #cpf-icon.invalid {
        display: inline; /* Exibido se inválido */
        color: red;
    }

    #cpf-icon.registered {
        display: inline; /* Exibido se já cadastrado */
        color: blue;
    }
    /* Ícone ao lado do input */
    #cpf-icon {
        font-size: 1.5em;  /* Tamanho do ícone */
        color: gray;       /* Cor padrão do ícone */
        margin-left: 10px; /* Espaçamento entre o input e o ícone */
    }

    

    #cnpj-icon {
        color: green; /* Cor padrão para o ícone de sucesso */
        display: none; /* Inicialmente oculto */
    }

    #cnpj-icon.valid {
        display: inline; /* Exibido se válido */
        color: green;
    }

    #cnpj-icon.invalid {
        display: inline; /* Exibido se inválido */
        color: red;
    }

    #cnpj-icon.registered {
        display: inline; /* Exibido se já cadastrado */
        color: blue;
    }
    /* Ícone ao lado do input */
    #cnpj-icon {
        font-size: 1.5em;  /* Tamanho do ícone */
        color: gray;       /* Cor padrão do ícone */
        margin-left: 10px; /* Espaçamento entre o input e o ícone */
    }

    /* Mensagem abaixo do campo CPF */
    #message_cpf {
        font-size: 14px;   /* Tamanho menor para o texto */
        color: gray;       /* Cor padrão para o texto */
        text-align: left;  /* Alinha o texto à esquerda */
        margin-top: 5px;   /* Espaçamento entre o campo e o texto */
    }

    .btn-taxa {
        width: auto; /* Ajusta o tamanho dos botões ao conteúdo */
        display: inline-block; /* Permite múltiplos botões lado a lado */
        padding: 8px 16px; /* Aumenta a área clicável */
        margin: 0 5px; /* Adiciona espaçamento horizontal entre os botões */
        font-size: 14px; /* Mantém o texto legível */
        border: none;
        border-radius: 5px;
        background-color: #07d870;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        vertical-align: center;
        flex-wrap: wrap;
        margin-top: 5px;
    }

    .btn-taxa:hover {
        background-color: #000000;
        transform: scale(1.05);
    }



    /* Responsividade */
    @media (max-width: 600px) {
    #planoInfo {
        font-size: 12px; /* Ajuste o tamanho da fonte para telas menores */
        padding: 5px; /* Reduza o padding se necessário */
    }
    #produtos{
        margin-right: 1px; /* Espaçamento entre o checkbox e o texto */
        width: 10%;
    }
    .produtos {
        flex-direction: column; /* Alinhar os itens verticalmente */
        gap: 5px; /* Reduz o espaçamento entre os elementos */
    }

    .produtos label {
        display: flex;
        align-items: center; /* Alinha verticalmente o texto e o checkbox */
        justify-content: flex-start; /* Alinha horizontalmente os itens */
        width: 100%; /* Garante que o label ocupe toda a largura disponível */
    }

    .produtos input[type="checkbox"] {
        margin-right: 10px; /* Adiciona espaço entre o checkbox e o texto */
        width: auto; /* Remove tamanho fixo */
    }

    .produtos input[type="number"] {
        width: 50%; /* Ajuste o tamanho no mobile */
        margin-left: 10px; /* Adiciona espaçamento em relação ao texto */
    }
    }



</style>
<script>

// Salva a sessão ativa no sessionStorage quando o usuário está na página
sessionStorage.setItem('sessaoAtiva', "true");

// Adiciona o evento de antes de sair da página
window.addEventListener("beforeunload", (event) => {
    // Verifica se a sessão ainda está ativa
    if (sessionStorage.getItem('sessaoAtiva') === "true") {
        // Se a sessão ativa existe, significa que a página foi apenas atualizada
        sessionStorage.removeItem('sessaoAtiva');
    } else {
        // Se não há sessão ativa, então o usuário realmente está saindo da página
        localStorage.setItem('loginAutorizado', "false");
        localStorage.removeItem('vendedores');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('loginAutorizado') !== "true") {
        alert("Acesso negado. Realize o login para continuar.");
        window.location.href = "index.html"; // Redireciona para a página de login
    }else{
        carregarCondominios()
        const vendedoresSelect = document.getElementById('vendedor');
        const vendedores = localStorage.getItem('vendedores').split(",")
        // alert(localStorage.getItem('vendedores'));

        if (vendedores && vendedores.length > 0) {
            vendedoresSelect.innerHTML = ''; // Limpa as opções atuais
            vendedores.forEach(vendedor => {
                const option = document.createElement('option');
                option.name = vendedor;
                option.textContent = vendedor;
                vendedoresSelect.appendChild(option);
            });
            const vendedor_option = document.createElement('option');
            vendedor_option.name = "44 - Outro Vendedor";
            vendedor_option.textContent = "44 - Outro Vendedor";
            vendedoresSelect.appendChild(vendedor_option);
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Nenhum vendedor disponível, favor realize o login';
            vendedoresSelect.appendChild(option);
        }
    }
});


// Algoritmo Arca
function Arca(){
    cpf = document.getElementById('cpf').value;
    cpf = cpf.replace(/[^\d]+/g, ''); // Remove caracteres não numéricos
    alert(cpf);
}

// Função para buscar endereço via API do ViaCEP
async function buscarEndereco(cep) {
    cep = cep.replace(/[^\d]/g, '')
    if (cep.length === 8) {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        if (!data.erro) {
            document.getElementById('endereco').value = data.logradouro;
            document.getElementById('bairro').value = data.bairro;
            document.getElementById('cidade').value = data.localidade;
        } else {
            alert('CEP não encontrado.');
        }
    }
}


// Função que preenche a taxa de instalação com base no valor do botão
async function preencherTaxa(valor) {
    const campoTaxa = document.getElementById('taxaInstalacao');
    if (valor == ""){
        campoTaxa.value = "";
    }
    campoTaxa.value = valor.toFixed(2).replace('.', ','); // Formata o valor como "90,00"
}


// Função que abre o campo para informar o CPF de quem indicou o cliente 
async function preencherIndiqueGanhe() {
    const comoConheceu = document.getElementById("comoConheceu").value;
    const IndiqueGanheRow = document.getElementById("IndiqueGanhe");
    const IndiqueGanheInput = IndiqueGanheRow.querySelector('input');

    if (comoConheceu == 4) {
        IndiqueGanheRow.style.display = 'table-row';
    } else {
        IndiqueGanheRow.style.display = 'none';
        IndiqueGanheInput.value = ''; // Limpa o campo CPF
    }
}


// Função de validação do CPF
async function validarCPF(cpf) {
    const cpfInput = document.getElementById('cpf');
    const iconSpan = document.getElementById('cpf-icon');
    const messageDiv = document.getElementById('message_cpf');
    const temCadastroRow = document.getElementById('segundoContrato');

    if (cpfInput == ""){
        iconSpan == '';
        messageDiv == '';
        temCadastroRow == '';
        cpfInput.classList.remove('valid', 'invalid', 'registered');
        iconSpan.classList.remove('valid', 'invalid', 'registered');
    }

    // Função auxiliar para atualizar o estado visual
    const atualizarEstado = (classe, icone, mensagem = "", mostrarIcone = true) => {
        if (classe) {
            cpfInput.classList.remove('valid', 'invalid', 'registered');
            iconSpan.classList.remove('valid', 'invalid', 'registered');
            cpfInput.classList.add(classe);
            iconSpan.classList.add(classe);
        }
        iconSpan.style.display = mostrarIcone ? "inline" : "none";
        iconSpan.innerHTML = icone;
        messageDiv.innerText = mensagem;
        messageDiv.style.color = classe === "valid" ? "green" : classe === "invalid" ? "red" : "blue";
    };

    // Limpar estado inicial
    cpf = cpf.replace(/[^\d]+/g, ''); // Remove caracteres não numéricos
    messageDiv.innerText = '';
    iconSpan.style.display = "none";
    temCadastroRow.style.display = 'none';

    if (!cpf) {
        atualizarEstado('', '', '', false);
        messageDiv.innerText = '';
        iconSpan.style.display = "none";
        temCadastroRow.style.display = 'none';
        return false;
    }

    // Validação local do CPF
    if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) {
        atualizarEstado("invalid", '<i class="fas fa-times-circle"></i>', "CPF inválido.");
        return false;
    }

    // Validar dígitos verificadores
    const validarDigito = (pesos) => {
        const soma = cpf
            .slice(0, pesos.length)
            .split('')
            .reduce((acc, num, idx) => acc + parseInt(num) * pesos[idx], 0);

        let resto = (soma * 10) % 11;
        return resto === 10 ? 0 : resto;
    };

    if (validarDigito([10, 9, 8, 7, 6, 5, 4, 3, 2]) !== parseInt(cpf.charAt(9)) ||
        validarDigito([11, 10, 9, 8, 7, 6, 5, 4, 3, 2]) !== parseInt(cpf.charAt(10))) {
        atualizarEstado("invalid", '<i class="fas fa-times-circle"></i>', "CPF inválido.");
        return false;
    }

    // CPF válido localmente
    atualizarEstado("valid", '<i class="fas fa-check-circle"></i>', "CPF válido. Verificando no servidor...");

    // Formatar CPF para exibição no request
    const cpfFormatado = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    const url = 'https://webhookn8nv2.mychat.solutions/webhook/login-vendas-automaticas';

    // Verificar com o servidor
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requisição: "check_documento", tipo_documento: "cpf", cnpj_cpf: cpfFormatado }),
        });

        const resultado = await response.text();

        if (resultado !== "Sem cadastro") {
            atualizarEstado("registered", '<i class="fas fa-info-circle"></i>', resultado);
            temCadastroRow.style.display = 'table-row';
            temCadastroRow.checked = true;

        } else {
            atualizarEstado("valid", '<i class="fas fa-check-circle"></i>', "CPF válido e disponível para cadastro.");
        }
    } catch (error) {
        console.error("Erro na requisição:", error);
        atualizarEstado("invalid", '<i class="fas fa-times-circle"></i>', "Erro ao verificar o CPF.", true);
        return false;
    }

    return true;
}


// Função de validação do CNPJ
async function validarCNPJ(cnpj) {
    // Remove caracteres não numéricos
    cnpj = cnpj.replace(/[^\d]+/g, '');
    
    const cnpjInput = document.getElementById('cnpj');
    const iconSpan = document.getElementById('cnpj-icon');
    const messageDiv = document.getElementById('message_cnpj');
    const temCadastroRow = document.getElementById('segundoContrato');

    if (!cnpj) {
        cnpjInput.classList.remove('valid', 'invalid', 'registered');
        iconSpan.style.display = 'none';
        iconSpan.className = ''; // Remove todas as classes do ícone
        iconSpan.innerHTML = ''; // Limpa o conteúdo do ícone
        messageDiv.innerText = ''; // Limpa a mensagem
        return false;
    }
    
    // Função auxiliar para atualizar o estado visual
    function atualizarEstado(classe, icone, mensagem = '', mostrarIcone = true) {
        const cnpjInput = document.getElementById('cnpj');
        const iconSpan = document.getElementById('cnpj-icon');
        const messageDiv = document.getElementById('message_cnpj');

        if (classe) {
            cnpjInput.classList.remove('valid', 'invalid', 'registered');
            iconSpan.classList.remove('valid', 'invalid', 'registered');
            cnpjInput.classList.add(classe);
            iconSpan.classList.add(classe);
        }
        iconSpan.style.display = mostrarIcone ? 'inline' : 'none';
        iconSpan.innerHTML = icone;
        messageDiv.innerText = mensagem;
        messageDiv.style.color = classe === 'valid' ? 'green' : classe === 'invalid' ? 'red' : 'blue';
    }

    // Validações básicas
    if (cnpj.length !== 14) {
        atualizarEstado('invalid', '<i class="fas fa-times-circle"></i>', 'CNPJ deve ter 14 dígitos.');
        return false;
    }

    if (/^(\d)\1+$/.test(cnpj)) {
        atualizarEstado('invalid', '<i class="fas fa-times-circle"></i>', 'CNPJ inválido (repetição de dígitos).');
        return false;
    }

    // Função auxiliar para calcular os dígitos verificadores
    function calcularDigito(cnpjParcial, pesos) {
        const soma = cnpjParcial
            .split('')
            .reduce((acc, num, idx) => acc + parseInt(num) * pesos[idx], 0);
        const resto = soma % 11;
        return resto < 2 ? 0 : 11 - resto;
    }

    // Pesos para o cálculo dos dígitos verificadores
    const pesosPrimeiroDigito = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
    const pesosSegundoDigito = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];

    // Cálculo do primeiro dígito verificador
    const primeiroDigito = calcularDigito(cnpj.slice(0, 12), pesosPrimeiroDigito);

    // Cálculo do segundo dígito verificador
    const segundoDigito = calcularDigito(cnpj.slice(0, 13), pesosSegundoDigito);

    // Comparação dos dígitos calculados com os fornecidos
    if (
        primeiroDigito !== parseInt(cnpj.charAt(12)) ||
        segundoDigito !== parseInt(cnpj.charAt(13))
    ) {
        atualizarEstado('invalid', '<i class="fas fa-times-circle"></i>', 'CNPJ inválido.');
        return false;
    }

    // CNPJ válido localmente
    atualizarEstado('valid', '<i class="fas fa-check-circle"></i>', 'CNPJ válido. Verificando no servidor...');

    // Verificação no servidor
    const cnpjFormatado = cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
    try {
        const response = await fetch('https://webhookn8nv2.mychat.solutions/webhook/login-vendas-automaticas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requisição: 'check_documento', tipo_documento: 'cnpj', cnpj_cpf: cnpjFormatado }),
        });

        const resultado = await response.text();

        if (resultado !== 'Sem cadastro') {
            atualizarEstado('registered', '<i class="fas fa-info-circle"></i>', resultado);
            temCadastroRow.style.display = 'table-row';
        } else {
            atualizarEstado('valid', '<i class="fas fa-check-circle"></i>', 'CNPJ válido e disponível para cadastro.');
        }
    } catch (error) {
        console.error('Erro na requisição:', error);
        atualizarEstado('invalid', '<i class="fas fa-times-circle"></i>', 'Erro ao verificar o CNPJ no servidor.');
        return false;
    }

    return true;
}


// Função de validação de Email
async function validarEmail(email) {
    const regex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;

    if (regex.test(email)) {
        return regex.test(email);
    } else {
        alert('E-mail incorreto');
        return false;
    }
}


// Função de validação de celular e WhatsApp (exige 11 dígitos)
async function validarCelular(numero) {
    numero = numero.replace("(","").replace(")","").replace("-","").replace(" ","")
    // return /^\d{11}$/.test(numero)
    const regex = /^(?:\d{2})?\d{8,9}$/;

      if (regex.test(numero)) {
        return regex.test(numero);
      } else {
        alert('Número incorreto');
        return regex.test(numero);
      }
}


// Função de obter o valor selecionado 
function obterValorSelecionado(nomeCampo) {
    const elementoSelecionado = document.querySelector(`input[name="${nomeCampo}"]:checked`);
    return elementoSelecionado ? elementoSelecionado.value : null; // Retorna o valor ou null se nada estiver selecionado
}


// Função de obter os produtos selecionados e as quantidades
function obterProdutosSelecionados() {
    const checkboxes = document.querySelectorAll('input[name="produtos[]"]:checked');
    const produtosSelecionados = {};

    checkboxes.forEach(checkbox => {
        const produtoId = checkbox.id;
        const quantidadeInput = document.getElementById(`${produtoId}_qtd`);
        const quantidade = quantidadeInput && quantidadeInput.value ? quantidadeInput.value : 1; // Padrão de quantidade 1 se não preenchido
        produtosSelecionados[checkbox.value] = [produtoId, quantidade];
    });
    return produtosSelecionados;
}


// Funçao de busca os dados de um condomínio selecionado no servidor
async function buscarDadosCondominio(id) {
    const condominioId = document.getElementById('condominio').value;

    const bloco = document.getElementById('linhaBloco');
    const apartamento = document.getElementById('linhaApartamento');
    
    if (condominioId===''){
        document.getElementById('endereco').value = '';
        document.getElementById('cep').value = '';
        document.getElementById('numero').value = '';
        document.getElementById('bairro').value = '';
        document.getElementById('cidade').value = '';

        bloco.style.display = 'none';
        apartamento.style.display = 'none';
    }
    // Verifique se um condomínio foi selecionado
    if (!condominioId) return;

    bloco.style.display = 'table-row';
    apartamento.style.display = 'table-row';
    bloco.setAttribute('required', '');
    apartamento.setAttribute('required', '');

    const id_condominio = condominioId.split(" - ")[0]

    const url = 'https://webhookn8nv2.mychat.solutions/webhook/login-vendas-automaticas';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({"requisição": "condominio",
                    "id_condominio": id_condominio})
        });

        console.log(response)
        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
            throw new Error("Erro ao buscar dados do condomínio.");
        }

        // Corrigido para response.json() (minúsculas)
        const dados = await response.json();

        // Preenche os campos de endereço com os dados recebidos
        document.getElementById('endereco').value = dados.endereco || '';
        document.getElementById('cep').value = dados.cep || '';
        document.getElementById('numero').value = dados.numero || '';
        document.getElementById('bairro').value = dados.bairro || '';
        document.getElementById('cidade').value = dados.nome_cidade || '';


    } catch (error) {
        console.error("Erro ao buscar dados do condomínio:", error);
        alert("Não foi possível obter os dados do condomínio.");
    }
}


// Função que busca os SVA's de um plano no servidor
async function buscarDadosPlano() {
    const planoId = document.getElementById('planos').value.split(".")[0];
    if (!planoId) return;

    const url = 'https://webhookn8nv2.mychat.solutions/webhook/login-vendas-automaticas';

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({"requisição": "plano",
                "id_plano": planoId})
     });

    const dados_plano = await response.text();
    // console.log(dados_plano)
    document.getElementById('planoInfo').innerText = dados_plano || ''
    // Verifica se a resposta foi bem-sucedida
    if (!response.ok) {
        throw new Error("Erro ao buscar dados do condomínio.");
    }
}


// Função que carrega nas opções todos os condomínios do servidor
async function carregarCondominios() {
    try {
        const response = await fetch('https://webhookn8nv2.mychat.solutions/webhook/login-vendas-automaticas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({"requisição": "get_condominios","id": "0"})
        });
        // Obtém a resposta como texto, pois não é um JSON
        const textResponse = await response.text();
        // Divide a string em uma lista de condomínios individuais usando a vírgula e o espaço
        const listaCondominios = textResponse.split(", ");
        // Seleciona o elemento dropdown para os condomínios
        const condominioSelect = document.getElementById('condominio');
        // Adiciona cada condomínio como uma nova opção
        listaCondominios.forEach(condominio => {
            const option = document.createElement('option');
            option.value = condominio;
            option.textContent = condominio;
            condominioSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Erro ao carregar condomínios:", error);
    }
}


// Função que retorna uma string vazia se o campo estiver vazio
function getValueOrEmpty(elementId) {
    const element = document.getElementById(elementId);
    return element ? element.value || "" : ""; // Retorna o valor ou uma string vazia
}


// Função que altera os campos para preenchimento Pessoa Fisica/Pessoa Jurídica
function alternarTipoCliente(tipo) {
    const camposFisica = document.getElementById("camposPessoaFisica");
    const camposJuridica = document.getElementById("camposPessoaJuridica");

    if (tipo === "F") {
        camposFisica.style.display = "table-row-group";
        camposJuridica.style.display = "none";
        limparCampos("camposPessoaJuridica");
    } else if (tipo === "J") {
        camposFisica.style.display = "none";
        camposJuridica.style.display = "table-row-group";
        limparCampos("camposPessoaFisica");
    }
}


// Função que limpa todos os campos de cadastro
function limparCampos(idGrupo) {
    const grupo = document.getElementById(idGrupo);
    const inputs = grupo.querySelectorAll("input");
    const cpfIcon = document.getElementById("cpf-icon");
    const messageCpf = document.getElementById("message_cpf");
    const temCadastroRow = document.getElementById('segundoContrato');

    temCadastroRow.style.display = 'none'

    // Limpa todos os inputs
    inputs.forEach(input => {
        input.value = "";
        input.checked = false; // Reseta checkboxes e radios, se houver
    });

    // Limpa os elementos específicos do CPF
    if (cpfIcon) {
        cpfIcon.style.display = "none";
        cpfIcon.className = ""; // Remove classes
        cpfIcon.innerHTML = ""; // Remove conteúdo do ícone
    }

    if (messageCpf) {
        messageCpf.innerText = ""; // Remove texto da mensagem
    }
}


// Envio do formulário e validações para o servidor
async function enviarFormulario(event) {
    event.preventDefault();

    const cpf = document.getElementById('cpf').value;
    const email = document.getElementById('email').value;
    const celular = document.getElementById('celular').value;
    const whatsapp = document.getElementById('whatsapp').value;
    const sexo = obterValorSelecionado("sexo");
    const moradia = obterValorSelecionado("moradia");

    if (!validarCPF(cpf)) return alert('CPF inválido!');
    if (!validarEmail(email)) return alert('E-mail inválido!');
    if (!validarCelular(celular) || !validarCelular(whatsapp)) return alert('Número de celular/WhatsApp inválido!');

    const dados = {
        nome: document.getElementById('nome').value,
        sexo,
        cpf,
        segundo_contrato: obterValorSelecionado("temCadastro"),
        rg: await getValueOrEmpty('rg'),
        dataNascimento: document.getElementById('dataNascimento').value,
        celular,
        whatsapp,
        email,
        condominio: document.getElementById('condominio').value,
        id_condominio: document.getElementById('condominio').value.split(" - ")[0],
        cep: document.getElementById('cep').value,
        endereco: document.getElementById('endereco').value,
        numero: document.getElementById('numero').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        complemento: await getValueOrEmpty('complemento'),
        bloco: await getValueOrEmpty('bloco'),
        apartamento: await getValueOrEmpty('apartamento'),
        moradia,
        vendedor: document.getElementById('vendedor').value,
        id_vendedor: document.getElementById('vendedor').value.split(" - ")[0],
        plano: document.getElementById('planos').value,
        id_plano: document.getElementById('planos').value.split(" - ")[0].split(".")[0],
        id_velocidade: document.getElementById('planos').value.split(" - ")[0].split(".")[1],
        produtosAdicionais: obterProdutosSelecionados(),
        vencimento: document.getElementById('vencimento').value,
        taxaInstalacao: document.getElementById('taxaInstalacao').value,
        comoConheceu: document.getElementById('comoConheceu').value,
        profissao: document.getElementById('profissao').value,
        concorrente: document.getElementById('concorrente').value,
        observacao: await getValueOrEmpty('observacao'),
        dataInstalacao: document.getElementById('dataInstalacao').value,
        periodoInstalacao: document.getElementById('periodoInstalacao').value,
        svaInclusos: document.getElementById('planoInfo').innerText,
        // Pessoa Jurídica
        razaoSocial: await getValueOrEmpty('razaoSocial'),
        cnpj: await getValueOrEmpty('cnpj'),
        inscricaoEstadual: await getValueOrEmpty('inscricaoEstadual'),
        contribuinteIcms: obterValorSelecionado("contribuinteIcms"),
        representanteLegal: await getValueOrEmpty('representanteLegal'),
        cpfRepresentanteLegal: await getValueOrEmpty('cpfRepresentanteLegal'),

        // Indicação (opcional)
        cpfIndique: await getValueOrEmpty('cpfIndique'),

        // Resultado da consulta SCPC/Serasa
        restricaoInfo: document.getElementById('restricaoInfo').innerText

    };


    const url = 'https://webhookn8nv2.mychat.solutions/webhook/venda-automatica';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });

        if (response.ok) {
            alert('Formulário enviado com sucesso!');
            document.getElementById('formVendas').reset();
        } else {
            alert('Erro ao enviar o formulário. Verifique o servidor.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao enviar o formulário. Verifique a conexão.');
    }
}


</script>
</head>
<body>
<form id="formVendas" onsubmit="enviarFormulario(event)">
    <h1>Formulário de Vendas</h1>
    <table border="1">
        <tr><th></th><td id="tipoCliente" style="text-align: center;">
                <label>
                    <input type="radio" name="tipoCliente" value="F" onclick="alternarTipoCliente(this.value)" checked> Pessoa Física
                </label>
                <label>
                    <input type="radio" name="tipoCliente" value="J" onclick="alternarTipoCliente(this.value)"> Pessoa Jurídica
                </label>
            </td>
        </tr>
        <tr id="segundoContrato" style="display: none;"><th>Possui cadastro?:</th>
            <td id="temCadastro" style="text-align: center;">
            <label><input type="checkbox" id="S" name="temCadastro" value="S"> Sim</label>
        </td></tr>

        <tbody id="camposPessoaFisica">
        <tr><th>Nome:</th><td><input type="text" id="nome" ></td></tr>
        <tr><th>CPF:</th>
            <td style="position: relative; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center;">
                    <input type="text" id="cpf" onchange="validarCPF(this.value)" style="flex: 1; margin-right: 10px;">
                    <span id="cpf-icon" style="font-size: 1.2em;"></span>
                </div>
                <div id="message_cpf" class="message" style="margin-top: 5px;"></div>
        </td></tr>        
        <tr><th>RG:</th><td><input type="text" id="rg" ></td></tr>
        <tr><th>Data de Nascimento:</th><td><input type="date" id="dataNascimento" ></td></tr>
        <tr><th>Sexo:</th><td id="sexo" style="text-align: center;">
            <label><input type="radio" id="M" name="sexo" value="M"> Masculino</label>
            <label><input type="radio" id="F" name="sexo" value="F"> Feminino</label>
        </td></tr>
        </tbody>

        <tbody id="camposPessoaJuridica" style="display: none;">
            <tr><th>Razão Social:</th><td><input type="text" id="razaoSocial"></td></tr>
            <tr><th>CNPJ:</th>
                <td style="position: relative; display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="cnpj" onchange="validarCNPJ(this.value)" style="flex: 1; margin-right: 10px;">
                        <span id="cnpj-icon" style="font-size: 1.2em;"></span>
                    </div>
                    <div id="message_cnpj" class="message" style="margin-top: 5px;"></div>
            </td></tr>
            <tr><th>Inscrição Estadual:</th><td><input type="text" id="inscricaoEstadual"></td></tr>
            <tr><th>Contribuinte ICMS:</th>
                <td id="contribuinteIcms" style="text-align: center;">
                    <label><input type="radio" name="contribuinteIcms" value="S"> Sim</label>
                    <label><input type="radio" name="contribuinteIcms" value="N"> Não</label>
                    <label><input type="radio" name="contribuinteIcms" value="I"> Isento</label>
                </td>
            </tr>
            <tr><th>Representante Legal:</th><td><input type="text" id="representanteLegal"></td></tr>
            <tr><th>CPF Representante Legal:</th><td><input type="text" id="cpfRepresentanteLegal"></td></tr>
        </tbody>


        <tr><th colspan="2" style="text-align: center;"><button type="button" id="arca" onclick="Arca()">Consulta SCPC e Serasa</button></td></tr>
        <tr><th>Resultado Consulta:</th><td><div id="restricaoInfo"></div></td></tr>
        <tr><th>Celular:</th><td><input type="text" id="celular"  onchange="validarCelular(this.value)"></td></tr>
        <tr><th>WhatsApp:</th><td><input type="text" id="whatsapp"  onchange="validarCelular(this.value)"></td></tr>
        <tr><th>Email:</th><td><input type="email" id="email"  onchange="validarEmail(this.value)"></td></tr>
    </table>
    <table>
        <tr><th>Condomínio:</th><td><select  id="condominio" onchange="buscarDadosCondominio()">
            <option value="" disabled selected>Selecione o condomínio</option>
            <option></option>
        </select></td></tr>
        <tr><th>CEP:</th><td><input type="text" id="cep"  onchange="buscarEndereco(this.value)"></td></tr>
        <tr><th>Endereço:</th><td><input type="text" id="endereco" ></td></tr>
        <tr><th>Número:</th><td><input type="text" id="numero" ></td></tr>
        <tr><th>Bairro:</th><td><input type="text" id="bairro" ></td></tr>
        <tr><th>Cidade:</th><td><input type="text" id="cidade" ></td></tr>
        <tr><th>Complemento:</th><td><input type="text" id="complemento"></td></tr>
        <tr id="linhaBloco" style="display: none;";><th>Bloco:</th><td><input type="text" id="bloco"></td></tr>
        <tr id="linhaApartamento" style="display: none;"><th>Apartamento:</th><td><input type="text" id="apartamento"></td></tr>
        <tr><th>Moradia:</th><td id="moradia" style="text-align: center;">
            <label><input type="radio" id="P" name="moradia" value="P"> Casa Propria</label>
            <label><input type="radio" id="A" name="moradia" value="A"> Casa Alugada</label>
        </td></tr>
    </table>
    <table>
        <tr><th>Vendedor:</th><td><select id="vendedor" > 
            <option value="" disabled selected>Selecione o vendedor</option>
        </select></td></tr>
        <tr><th>Planos:</th><td><select id="planos" onchange="buscarDadosPlano(this.value)" >
            <option value="" disabled selected>Selecione um plano</option>
            <option>52.16 - FIBER_300_V5</option>
            <option>53.15 - FIBER_400_V5</option>
            <option>54.17 - FIBER_500_V5</option>
            <option>68.18 - FIBER_600_V5</option>
            <option>55.18 - FIBER_600_V5+GLOBOPLAY</option>
            <option>56.13 - FIBER_650_GAMER_IP</option>
            <option>57.11 - FIBER_1G_V5</option>
            <option>58.16 - FIBER_300_CONDOMINIO_V5</option>
            <option>59.15 - FIBER_400_CONDOMINIO_V5</option>
            <option>60.17 - FIBER_500_CONDOMINIO_V5</option>
            <option>69.18 - FIBER_600_CONDOMINIO_V5</option>
            <option>61.18 - FIBER_600_CONDOMINIO_V5+GLOBOPLAY</option>
        </select></td></tr>
        <tr><th>SVA's Inclusos:</th><td><div id="planoInfo"></div></td></tr>
        <tr><th>Produtos Adicionais:</th>
            <td class="produtos">
                <label>
                    <input type="checkbox" id="251" name="produtos[]" value="Repetidor"> Repetidor
                    <input type="number" id="251_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="176" name="produtos[]" value="Redbox"> Redbox
                    <input type="number" id="176_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="15" name="produtos[]" value="RedFone"> RedFone
                    <input type="number" id="15_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="169" name="produtos[]" value="Watch"> Watch
                    <input type="number" id="169_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="264" name="produtos[]" value="LevEduca"> LevEduca
                    <input type="number" id="264_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="265" name="produtos[]" value="Telemedicina"> Telemedicina
                    <input type="number" id="265_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="256" name="produtos[]" value="IP Público"> IP Público
                    <input type="number" id="256_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="premiere" name="produtos[]" value="Premiere"> Premiere
                    <input type="number" id="premiere_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="306" name="produtos[]" value="Deezer"> Deezer
                    <input type="number" id="306_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="305" name="produtos[]" value="Max HBO"> Max HBO
                    <input type="number" id="305_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="207" name="produtos[]" value="RedTV"> RedTV
                    <input type="number" id="207_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="310" name="produtos[]" value="Livro Digital S"> Livro Digital S
                    <input type="number" id="310_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>
                <br>
                <label>
                    <input type="checkbox" id="309" name="produtos[]" value="Antivirus"> Antivirus
                    <input type="number" id="309_qtd" name="qtd_produtos[]" placeholder="Qtd" min="0" max="10">
                </label>               
            </td></tr>
        </tr>
        <tr><th>Vencimento:</th><td><select id="vencimento" >
            <option value="" disabled selected>Selecione um dia para vencimento</option>
            <option value="34">Dia 7</option>
            <option value="10">Dia 10</option>
            <option value="36">Dia 15</option>
        </select></td></tr>
        <tr>
            <th>Taxa de Instalação:</th>
            <td>
                <input type="text" id="taxaInstalacao">
                <div style="margin-top: 10px; text-align: center;">
                    <button type="button" class="btn-taxa" onclick="preencherTaxa(0)">Isento</button>
                    <button type="button" class="btn-taxa" onclick="preencherTaxa(90)">90,00</button>
                    <button type="button" class="btn-taxa" onclick="preencherTaxa(100)">100,00</button>
                    <button type="button" class="btn-taxa" onclick="preencherTaxa(120)">120,00</button>
                    <button type="button" class="btn-taxa" onclick="preencherTaxa('')">Outro valor</button>
                </div>
            </td>
        </tr>
        <tr><th>Como Conheceu:</th><td><select  id="comoConheceu" onchange="preencherIndiqueGanhe(this.value)">
            <option value="" disabled selected>Selecione como o cliente conheceu a empresa</option>
            <option id="Sondagem" value="6">Sondagem</option>
            <option id="Panfletagem" value="10">Panfletagem</option>
            <option id="Outdoor" value="14">Outdoor</option>
            <option id="Loja" value="12">Loja</option>
            <option id="Já é cliente" value="1">Já é cliente</option>
            <option id="Instagram" value="13">Instagram</option>
            <option id="Indicação de outros clientes" value="4">Indicação de outros clientes</option>
            <option id="Google" value="2">Google</option>
            <option id="Feiras" value="7">Feiras</option>
            <option id="Facebook" value="3">Facebook</option>
            <option id="CTO no poste" value="17">CTO no poste</option>
            <option id="Carro de som" value="16">Carro de som</option>
            <option id="Carro da empresa" value="15">Carro da empresa</option>
            <option id="Outros (Especificar na Observação)" value="8">Outros (Especificar na Observação)</option>
        </select></td></tr>
        </td><tr id="IndiqueGanhe" style="display: none;";><th>Insira o CPF do cliente que indicou:</th><td>
            <input type="text" id="cpfIndique">
        </td></tr>
        <tr><th>Profissão:</th><td><input type="text" id="profissao"></td></tr>
        <tr><th>Antigo provedor:</th><td><input type="text" id="concorrente"></td></tr>
        <tr><th>Observação:</th><td><textarea id="observacao"></textarea></td></tr>
        <tr><th>Data de Instalação:</th><td><input type="date" id="dataInstalacao" ></td></tr>
        <tr><th>Período de Instalação:</th><td><select id="periodoInstalacao">
            <option value="" disabled>Selecione o período</option>
            <option>Manhã</option>
            <option>Tarde</option>
            <option selected>Horário comercial</option>
        </select></td></tr>
        <tr><td colspan="2" style="text-align: center;"><button type="submit">Enviar</button></td></tr>
    </table>
</form>
</body>
</html>